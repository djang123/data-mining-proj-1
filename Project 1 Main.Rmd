---
title: "Project 1 Main"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#general
library(tidyverse)
library(httr)
#for 311 data
library("RSocrata")

#pulling data
library(jsonlite)

#mapping libraries
library(tigris)
library(leaflet)
library(sp)
library(ggmap)
library(maptools)
library(broom)
library(rgdal)
library(lubridate)
library(plyr)
```

### 311 data

```{r API info, include=FALSE}
api_key <- "1x1syxa046asdu0rkk842sht5"
api_key_secret <- "3y8qpo8krd82vwnhxxjufuk8fv35tidgvc0gx2dhnbgeor1900"
token <- "ADRRlI3DDJge67NUzvmCG3vU3"
```


```{r Sample Data Pulls, eval=FALSE, include=FALSE}
#sample pull of 1 entry
#https://data.cityofnewyork.us/resource/erm2-nwe9.json?unique_key=10693408

#sample pull of 10
#df <- read.socrata(url = "https://data.cityofnewyork.us/resource/erm2-nwe9.json?$limit=10")
```

```{r 311 data pull}

# Call in NYC data for 2019
nyc <-  as_tibble(read.socrata("https://data.cityofnewyork.us/resource/fhrw-4uyv.json?$where=created_date between '2018-01-01T12:00:00' and '2018-12-31T23:59:59' and agency = 'NYPD'", app_token = token))

#head(nyc)

#clean the data
df_311 <- nyc %>% 
  mutate_at(vars(incident_zip, latitude, longitude, location_zip), as.numeric) %>% 
  select(-cross_street_1,-cross_street_2,-address_type,-facility_type,-due_date,-bbl,-x_coordinate_state_plane,-y_coordinate_state_plane,-park_facility_name,-park_borough,  -location_address,-location_state, -location_zip,-intersection_street_1,-intersection_street_2, -landmark,-bridge_highway_name,-bridge_highway_direction,-bridge_highway_segment,-road_ramp, -incident_address, -street_name, -location_city)
  
#glimpse(df_311)
```




### Salary Data

```{r}
#select only 1 year
url_2018 <- "https://data.cityofnewyork.us/resource/k397-673e.json?fiscal_year=2019"

#create dataframe of payroll
df_payroll <- as_tibble(read.socrata(url_2018))

df_payroll_cleaned <- df_payroll %>%
  mutate_at(vars(fiscal_year,
         payroll_number,
         base_salary,
         ot_hours,
         regular_gross_paid,
         total_ot_paid,
         total_other_pay), as.numeric) %>% 
  mutate(total_pay = regular_gross_paid + total_ot_paid + total_other_pay)


df_payroll_cleaned
```

```{r eval=FALSE, include=FALSE}
summary(df_payroll_cleaned)
```



```{r warning=FALSE}
ggplot(df_payroll_cleaned, aes(x = year(agency_start_date))) + 
  geom_histogram(binwidth = 1) + 
  xlim(1960,2021)

```


### Exploring the data

```{r warning=FALSE}
#head(df_311)

counts_of_start_type <- df_311 %>% 
  group_by(open_data_channel_type) %>% 
  summarize(number_rows = n())

location_type_count <- df_311 %>% 
  group_by(location_type) %>% 
  summarize(number_rows = n()) %>% 
  arrange(decreasing = TRUE) %>% 
  top_n(5)
  
```

```{r}
ggplot(counts_of_start_type, aes(x = "", y = number_rows, fill = open_data_channel_type)) + 
  geom_bar(stat = "identity", width = 1, color="white") + 
  coord_polar("y", start = 0) + 
  theme_void() # remove background, grid, numeric labels

ggplot(location_type_count, aes(x = "", y = number_rows, fill = location_type)) + 
  geom_bar(stat = "identity", width = 1, color="white") + 
  coord_polar("y", start = 0) + 
  theme_void() + # remove background, grid, numeric labels 
  labs(title = "Top 5 location calls")
```


```{r}
glimpse(df_payroll_cleaned)

 ## maybe we should look at pay by agency?

```


### Pay by department

```{r}
pay_by_department <- df_payroll_cleaned %>% 
  group_by(agency_name) %>% 
  summarise(Mean = mean(total_pay)) %>% 
  arrange(decreasing = TRUE)

bottom_pay_by_department <- pay_by_department %>% 
  arrange(desc(Mean)) %>% 
  top_n(-6) 
  

top_pay_by_department <- pay_by_department %>% 
  arrange(desc(Mean)) %>% 
  top_n(6)  
  

extreme_pay <- bind_rows(top_pay_by_department, bottom_pay_by_department)


graph_pay <- ggplot(extreme_pay, aes(x = agency_name, y = Mean))+
  geom_bar(stat = "identity") + 
  ggtitle("Mean pay by agency (top and bottom 6)") + 
  coord_flip()

graph_pay

```


### Does pay of community board effect responses?!

Clearly different community boards are paid very different amounts. Does this reflect their community? So, how does this effect their 311 response? We can look at it :
- Amount of 311 calls (more is probably worse?)
- Time between created and closed
- 

```{r}
dconverter<-function(x){
  boardnumber<-unlist(regmatches(x,gregexpr("[1-9]+",x)))
  board_district<-unlist(regmatches(x,gregexpr("[BMQSU][a-zA-z]+",x)))
  if (board_district[1]=="STATEN"){
  newname<-paste(board_district,"COMMUNITY BD #",boardnumber)
  } 
  else{
  newname<-paste(board_district,"COMMUNITY BOARD #",boardnumber)
  }
  return(newname[1])
}

#example 
#dconverter(levels(as.factor(df_311$community_board))[17])

#full conversion (current runtime ~1-2 min)
df_311$community_board_full<-laply(df_311$community_board,dconverter)
#duration, in minuts, of 311 cases
df_311$duration<-as.numeric((df_311$closed_date-df_311$created_date))



```



### Algo idea, compare 1 district to the neighboring?



```{r}
sorted_311_community_board <- df_311 %>% 
  group_by(community_board) %>% 
  summarize(number_rows = n()) %>% 
  arrange(desc(number_rows))

sorted_311_community_board



```



### Mapping of the data

```{r}
register_google(key = "AIzaSyAEkvFUTrN-n96QqRvpHxmtNyucQveP8oU")
```

 
```{r}
nyc_map <- get_map(location = c(lon = -74.00, lat = 40.71), maptype = "terrain", zoom = 11)
```


```{r}
ggmap(nyc_map)
```



```{r}
leaflet() %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 12)
```
```


